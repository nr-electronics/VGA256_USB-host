# VGA256_USB-host
 
A working example for 8-bit VGA display with USB-OTG (keyboard)
to play a simple tetris game and image display on A Black Pill 
(STM32F441CEU6)



All the settings:
SYSCLK = 96MHz (HSE /25 *192 /2 for SYSCLK  and /4 for USB)
VGA mode: 640x480@57.25Hz
using VGA 640x480@60Hz as reference (reducing pixel frequency from 25.175MHz down to 24MHz)

TIM10 is used for H-sync generation and a trigger for TIM9. Prescaler was set to 4-1 to get the pixel clock at 24MHz. Counter Period is 800-1 (full scan line). Also enable PWM1 with Pulse at 96-1 for H-Sync pulse (positive)

TIM9  is used for V-sync generation and was set in Slave Mode with Trigger source from ITR2 (OC of TIM10). (see more from User manual)
Prescaler was 0 (no division) and Counter period was 523 (VGA 640x480&@60Hz standard is 525 but a minute inaccuracy of STM32F411 produced slightly jittering/moving image so I cut some scan lines and it remedied the problem.)  PWM1 was used for V-Sync with Pulse was at 2-1. (2 scan lines)
 
TIM1 is used as time base for DMA. Prescaler is 2-1 and Counter Period is 4-1. This result in 8 times reduction so the actual pixel clock is 12MHz (96MHz/8).  This means each pixel clock generated by STM32 equal to 2 pixels on the screen. Also enable Event out to Update Event to be used as time base for DMA.

Under DMA settings, we enabled DMA2 Stream5 for TIM1_UP and direction was from memory to peripheral and Priority was very high. We set the DMA mode to Circular with data width was byte for both memory and peripheral. We also used FIFO with Full threashold. Burst size for peripheral was single but 16 increment for memory to reduced the amount of DMA interrupts the system bus. (You might disable FIFO and see the result.)

USB_OTG_FS mode was set to Host_Only without enabling the SOF nor VBUS. 

USB_HOST class was set to Human Interface Host Class (HID) and under Platform settings we enabled PA10 as dummy GPIO output then used PA10 for Drive_VBUS_FS. This pin will not be used anywhere in the program, just so STM32CubeIDE will not alarm anything at us.

Notes:
You have to provide additional 5V to USB-C connection. The Blackpill may accept 5V power from USB-C but does not provide 5V output. So you
have to use a modified cable with additional 5V to the cable so the device can work properly.

Known limitation:
-Since we feed VGA signal with a DMA and with a pixel clock at 12MHz, this is quite a feast for STM32F411. When connecting a USB keyboard, some flickering will occured and might more so when pressing keys because DMA misses the time period it was designed to send data to the GPIO. I did change some setting, like feeding TIM9 with internal clock and change Prescaler to 3200-1 instead of using TIM10 to trig the TIM9. This results in a smoother display but still not correct the problem.